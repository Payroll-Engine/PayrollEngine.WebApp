@page "/payrunresults"
@page "/payrunresults/{Payrun}"

@using PayrollEngine.WebApp
@using PayrollEngine.WebApp.ViewModel

@inherits PayrollEngine.WebApp.Presentation.PageBase

@if (!HasFeature(Feature.PayrunResults))
{
    NavigateHome();
    return;
}

<MudText Typo="Typo.h5" Class="my-4 pb-2 pt-4">Payrun Results</MudText>

@if (!HasPayroll)
{
    <div>Please select a Payroll</div>
    return;
}
@if (!HasEmployee)
{
    <div>Please select an Employee</div>
    return;
}
@if (!HasPayruns)
{
    <div>Please select a Payroll with a Payrun</div>
    return;
}

@* payrun selection *@
@if (SelectedPayrun == null)
{
    <div class="pa-1 mt-4">Please select a Payrun</div>
}

<MudStack Row="true" Spacing="0" Class="gap-2 my-4">
    <MudStack Spacing="0" Style="max-width: 22em">
        <MudSelect T="string"
                   Value="SelectedPayrunName"
                   ValueChanged="PayrunChanged"
                   Disabled="@(Payruns == null || Payruns.Count < 1)"
                   ReadOnly="@(Payruns == null || Payruns.Count == 1)"
                   Label="Payrun"
                   Variant="Variant.Outlined">
            @foreach (var payrun in Payruns)
            {
                <MudSelectItem T="string" Value="payrun.Name">
                    @UserLanguage.GetLocalization(payrun.NameLocalizations, payrun.Name)
                </MudSelectItem>
            }
        </MudSelect>
    </MudStack>
    @if (SelectedPayrun != null && HasFeature(Feature.PayrunJobs))
    {
        <MudButton Variant="Variant.Outlined" Color="Color.Info"
                   StartIcon="@Icons.Material.Filled.NavigateNext"
                   Style="height: fit-content; align-self: end;"
                   OnClick="NavigateToJobs">
            Jobs
        </MudButton>
    }
</MudStack>

@if (SelectedPayrun == null)
{
    return;
}

@* title and grid actions *@
<div class="d-flex pb-2">
    <div class="d-flex flex-grow-1 justify-end align-end">
        <MudTooltip Delay="500" Text="Compact view" Placement="Placement.Top">
            <MudIconButton @onclick="@ToggleGridDenseAsync"
                           Color="Color.Primary" Variant="Variant.Outlined"
                           Icon="@Icons.Material.Filled.ViewCompact"
                           Class="ml-2"
                           Size="Size.Small" />
        </MudTooltip>
        <MudTooltip Delay="500" Text="Filter reset" Placement="Placement.Top">
            <MudIconButton @onclick="@ResetFilterAsync"
                           Color="Color.Primary" Variant="Variant.Outlined"
                           Icon="@Icons.Material.Filled.FilterAltOff"
                           Class="ml-2"
                           Size="Size.Small" />
        </MudTooltip>
        <MudTooltip Delay="500" Text="Excel download" Placement="Placement.Top">
            <MudIconButton @onclick="@ExcelDownloadAsync"
                           Color="Color.Primary" Variant="Variant.Outlined"
                           Icon="@Icons.Custom.FileFormats.FileExcel"
                           Class="ml-2"
                           Size="Size.Small" />
        </MudTooltip>
    </div>
</div>

@* data grid *@
<MudDataGrid @ref="ResultsGrid" T="PayrollResultValue"
             ServerData="GetServerDataAsync"
             FilterMode="DataGridFilterMode.ColumnFilterRow"
             ColumnResizeMode="ResizeMode.Column"
             Dense="@Dense"
             Filterable="true"
             Groupable="false"
             Hideable="false"
             ShowColumnOptions="false"
             SortMode="SortMode.Multiple">
    <Columns>
        <PropertyColumn Property="x => x.PeriodStart" Title="Period" Format="MMM yyyy" InitialDirection="SortDirection.Descending" />
        <PropertyColumn Property="x => x.JobName" Title="Job Name" />
        <PropertyColumn Property="x => x.JobStatus" Title="Status" />
        <PropertyColumn Property="x => x.EmployeeIdentifier" Title="Employee" />
        <PropertyColumn Property="x => x.Forecast" Title="Forcast Name" />
        <PropertyColumn Property="x => x.ResultCreated" Title="Created">
            <CellTemplate>
                @ValueFormatter.ToCompactString(context.Item.ResultCreated)
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.ResultKind" Title="Result type" />
        <PropertyColumn Property="x => x.KindName" Title="Name" />
        <PropertyColumn Property="x => x.ResultValue" Title="Value" />
        <PropertyColumn Property="x => x.ResultNumericValue" Title="# Value" Format="0.##" />
        <CustomColumns T="PayrollResultValue" Columns="ColumnConfiguration" />
    </Columns>
    <PagerContent>
        <MudDataGridPager T="PayrollResultValue" />
    </PagerContent>
    <NoRecordsContent>
        No payrun results available
    </NoRecordsContent>
</MudDataGrid>
