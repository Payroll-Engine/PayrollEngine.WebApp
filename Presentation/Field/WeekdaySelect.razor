@using PayrollEngine.WebApp.Shared
@inherits FieldEditorBase;

<MudSelect T="int?"
@bind-Value="Field.ValueAsInteger"
           Label="@ValueLabel"
           HelperText="@ValueHelp"
           Error="@Error"
           Disabled="@ValuesDisabled"
           ReadOnly="@ReadOnly"
           Required="@Required"
           RequiredError="@ValueRequiredError"
           Adornment="@ValueAdornment"
           AdornmentText="@ValueAdornmentText">
    @foreach (var weekday in Weekdays)
    {
        <MudSelectItem T="int?" Value="@weekday.Item1">@weekday.Item2</MudSelectItem>
    }
</MudSelect>

@code
{
    [Inject] private Localizer Localizer { get; set; }

    protected override string ValueLabel { get; set; }
    private List<Tuple<int, string>> Weekdays { get; } = new();

    private bool ValuesDisabled =>
        Disabled || !Weekdays.Any();

    private void SetupWeekdays()
    {
        var culture = CultureInfo;
        // day names
        var dayNames = culture.DateTimeFormat.DayNames.ToList();

        // day order
        var firstDayOfWeek = culture.DateTimeFormat.GetDayName(culture.DateTimeFormat.FirstDayOfWeek);
        var currentDay = dayNames.First();
        while (currentDay != null)
        {
            if (string.Equals(currentDay, firstDayOfWeek))
            {
                break;
            }

            // move day to the end of the week
            dayNames.Remove(currentDay);
            dayNames.Add(currentDay);

            // next day
            currentDay = dayNames.First();
        }

        // apply days
        for (var i = 0; i < dayNames.Count; i++)
        {
            Weekdays.Add(new(i, dayNames[i]));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // label
        ValueLabel = Field.Attributes.GetValueLabel(Culture) ?? Localizer.Calendar.Day;
        // weekday names
        SetupWeekdays();

        await base.OnInitializedAsync();
    }
}
